<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Beat Store Download Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #121212;
        color: white;
      }
      .container {
        background-color: #1e1e1e;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
      }
      .form-group {
        margin-bottom: 15px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      input,
      select,
      button {
        width: 100%;
        padding: 10px;
        border: 1px solid #333;
        border-radius: 6px;
        background-color: #2a2a2a;
        color: white;
        font-size: 14px;
      }
      button {
        background-color: #1db954;
        border: none;
        cursor: pointer;
        font-weight: bold;
        margin-top: 10px;
      }
      button:hover {
        background-color: #1ed760;
      }
      button:disabled {
        background-color: #666;
        cursor: not-allowed;
      }
      .result {
        margin-top: 20px;
        padding: 15px;
        border-radius: 6px;
      }
      .success {
        background-color: #2e7d32;
        border: 1px solid #4caf50;
      }
      .error {
        background-color: #c62828;
        border: 1px solid #f44336;
      }
      .info {
        background-color: #1565c0;
        border: 1px solid #2196f3;
      }
    </style>
  </head>
  <body>
    <h1>üéµ Beat Store Download Test</h1>

    <div class="container">
      <h2>Step 1: Login</h2>
      <div class="form-group">
        <label for="username">Username:</label>
        <input
          type="text"
          id="username"
          value="testuser"
          placeholder="Enter username"
        />
      </div>
      <div class="form-group">
        <label for="password">Password:</label>
        <input
          type="password"
          id="password"
          value="testpass123"
          placeholder="Enter password"
        />
      </div>
      <button onclick="login()">Login</button>
      <div id="loginResult"></div>
    </div>

    <div class="container">
      <h2>Step 2: Get Beats</h2>
      <button onclick="getBeats()">Get Available Beats</button>
      <div id="beatsResult"></div>
    </div>

    <div class="container">
      <h2>Step 3: Test Download</h2>
      <div class="form-group">
        <label for="beatId">Beat ID:</label>
        <input type="number" id="beatId" placeholder="Enter beat ID" />
      </div>
      <div class="form-group">
        <label for="downloadType">Download Type:</label>
        <select id="downloadType">
          <option value="mp3">MP3</option>
          <option value="wav">WAV</option>
          <option value="stems">Stems</option>
        </select>
      </div>
      <button onclick="testDownload()">Test Download</button>
      <div id="downloadResult"></div>
    </div>

    <div class="container">
      <h2>Step 4: Test Purchase + Download</h2>
      <div class="form-group">
        <label for="purchaseBeatId">Beat ID:</label>
        <input type="number" id="purchaseBeatId" placeholder="Enter beat ID" />
      </div>
      <div class="form-group">
        <label for="purchaseType">Download Type:</label>
        <select id="purchaseType">
          <option value="mp3">MP3</option>
          <option value="wav">WAV</option>
          <option value="stems">Stems</option>
        </select>
      </div>
      <div class="form-group">
        <label for="price">Price:</label>
        <input
          type="number"
          id="price"
          value="9.99"
          step="0.01"
          placeholder="Enter price"
        />
      </div>
      <button onclick="testPurchaseAndDownload()">Purchase & Download</button>
      <div id="purchaseResult"></div>
    </div>

    <script>
      let accessToken = null;
      const baseUrl = "http://localhost:8000/api";

      async function login() {
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;
        const resultDiv = document.getElementById("loginResult");

        try {
          const response = await fetch(`${baseUrl}/token/`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ username, password }),
          });

          const data = await response.json();

          if (response.ok) {
            accessToken = data.access;
            resultDiv.innerHTML = `<div class="result success">‚úÖ Login successful! Token: ${accessToken.substring(
              0,
              20
            )}...</div>`;
          } else {
            resultDiv.innerHTML = `<div class="result error">‚ùå Login failed: ${
              data.detail || "Unknown error"
            }</div>`;
          }
        } catch (error) {
          resultDiv.innerHTML = `<div class="result error">‚ùå Login error: ${error.message}</div>`;
        }
      }

      async function getBeats() {
        const resultDiv = document.getElementById("beatsResult");

        try {
          const response = await fetch(`${baseUrl}/beats/`);
          const beats = await response.json();

          if (response.ok) {
            let html = '<div class="result info"><h3>Available Beats:</h3><ul>';
            beats.forEach((beat) => {
              html += `<li><strong>${beat.name}</strong> (ID: ${beat.id}) - ${beat.genre} - $${beat.price}</li>`;
            });
            html += "</ul></div>";
            resultDiv.innerHTML = html;
          } else {
            resultDiv.innerHTML = `<div class="result error">‚ùå Failed to get beats: ${response.statusText}</div>`;
          }
        } catch (error) {
          resultDiv.innerHTML = `<div class="result error">‚ùå Error: ${error.message}</div>`;
        }
      }

      async function testDownload() {
        const beatId = document.getElementById("beatId").value;
        const downloadType = document.getElementById("downloadType").value;
        const resultDiv = document.getElementById("downloadResult");

        if (!accessToken) {
          resultDiv.innerHTML =
            '<div class="result error">‚ùå Please login first</div>';
          return;
        }

        try {
          const response = await fetch(
            `${baseUrl}/beats/${beatId}/download/?type=${downloadType}`,
            {
              headers: {
                Authorization: `Bearer ${accessToken}`,
              },
            }
          );

          if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `beat_${beatId}_${downloadType}.${downloadType}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            resultDiv.innerHTML = `<div class="result success">‚úÖ Download successful! File size: ${blob.size} bytes</div>`;
          } else {
            const error = await response.text();
            resultDiv.innerHTML = `<div class="result error">‚ùå Download failed: ${response.status} - ${error}</div>`;
          }
        } catch (error) {
          resultDiv.innerHTML = `<div class="result error">‚ùå Error: ${error.message}</div>`;
        }
      }

      async function testPurchaseAndDownload() {
        const beatId = document.getElementById("purchaseBeatId").value;
        const downloadType = document.getElementById("purchaseType").value;
        const price = document.getElementById("price").value;
        const resultDiv = document.getElementById("purchaseResult");

        if (!accessToken) {
          resultDiv.innerHTML =
            '<div class="result error">‚ùå Please login first</div>';
          return;
        }

        try {
          // First, create a purchase
          const purchaseResponse = await fetch(
            `${baseUrl}/beats/${beatId}/purchase/`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${accessToken}`,
              },
              body: JSON.stringify({
                download_type: downloadType,
                price_paid: parseFloat(price),
                payment_method: "test",
              }),
            }
          );

          const purchaseData = await purchaseResponse.json();

          if (purchaseResponse.ok) {
            resultDiv.innerHTML = `<div class="result success">‚úÖ Purchase successful! ${purchaseData.message}</div>`;

            // Now test download
            setTimeout(async () => {
              try {
                const downloadResponse = await fetch(
                  `${baseUrl}/beats/${beatId}/download/?type=${downloadType}`,
                  {
                    headers: {
                      Authorization: `Bearer ${accessToken}`,
                    },
                  }
                );

                if (downloadResponse.ok) {
                  const blob = await downloadResponse.blob();
                  const url = window.URL.createObjectURL(blob);
                  const a = document.createElement("a");
                  a.href = url;
                  a.download = `beat_${beatId}_${downloadType}.${downloadType}`;
                  document.body.appendChild(a);
                  a.click();
                  document.body.removeChild(a);
                  window.URL.revokeObjectURL(url);

                  resultDiv.innerHTML += `<div class="result success">‚úÖ Download successful! File size: ${blob.size} bytes</div>`;
                } else {
                  const error = await downloadResponse.text();
                  resultDiv.innerHTML += `<div class="result error">‚ùå Download failed: ${downloadResponse.status} - ${error}</div>`;
                }
              } catch (error) {
                resultDiv.innerHTML += `<div class="result error">‚ùå Download error: ${error.message}</div>`;
              }
            }, 1000);
          } else {
            resultDiv.innerHTML = `<div class="result error">‚ùå Purchase failed: ${
              purchaseData.error || "Unknown error"
            }</div>`;
          }
        } catch (error) {
          resultDiv.innerHTML = `<div class="result error">‚ùå Error: ${error.message}</div>`;
        }
      }
    </script>
  </body>
</html>
